# Guide de Synchronisation Cloud-First

> **Guide ultra-complet pour maintenir votre environnement local synchronis√© avec Supabase Cloud**

## üéØ Objectif de ce Guide

Ce document explique **exactement** comment synchroniser votre repository local quand :

- Vous n'avez pas travaill√© sur votre PC pendant plusieurs jours
- Votre base de donn√©es cloud Supabase a chang√© (migrations, donn√©es, sch√©ma)
- Vous voulez toujours savoir si votre environnement local est √† jour

**‚ö†Ô∏è Important :** Ce guide est con√ßu pour une approche **cloud-first** sans CI/CD payant.

## üìã Vue d'Ensemble du Workflow

```mermaid
graph TD
    A[Ouvrir le projet] --> B[V√©rifier l'√©tat local]
    B --> C{Local √† jour ?}
    C -->|Non| D[Synchroniser]
    C -->|Oui| E[D√©velopper]
    D --> F[V√©rifier la sync]
    F --> E
    E --> G[Commit changements]
    G --> H[Pousser vers cloud]
```

## üöÄ Commandes de Synchronisation

### üì• Scripts Ajout√©s au package.json

```json
{
  "scripts": {
    "db:status": "supabase status --linked",
    "db:check": "node scripts/check-db-sync.js",
    "db:pull": "supabase db pull --linked",
    "db:push": "supabase db push --linked",
    "db:sync": "run-s db:pull types:gen db:check",
    "db:reset-local": "supabase db reset --linked",
    "migration:list": "supabase migration list --linked",
    "migration:status": "node scripts/migration-status.js",
    "types:gen": "supabase gen types --lang=typescript --schema=public --linked > apps/frontend/src/types/database.types.ts",
    "types:check": "node scripts/check-types-sync.js",
    "sync:full": "run-s db:sync types:check",
    "sync:check": "run-s db:check types:check migration:status"
  }
}
```

## üîç √âtape 1 : V√©rification de l'√âtat Initial

### Quand vous ouvrez le projet apr√®s quelques jours :

```bash
# 1. V√©rifier le statut git
git status
git pull origin main

# 2. Installer les d√©pendances (au cas o√π)
pnpm install

# 3. V√©rifier la connexion Supabase
pnpm db:status
```

**Ce que fait `pnpm db:status` :**

- Se connecte √† votre projet Supabase cloud
- Affiche l'√©tat des services (API, Auth, Storage, etc.)
- Confirme que votre CLI est bien li√© au bon projet cloud

### üîç Diagnostic Complet

```bash
# 4. V√©rifier l'√©tat de synchronisation complet
pnpm sync:check
```

**Ce que fait `pnpm sync:check` :**

1. **`db:check`** - Compare les migrations locales vs cloud
2. **`types:check`** - V√©rifie si les types TS sont √† jour
3. **`migration:status`** - Liste l'√©tat de chaque migration

## üîÑ √âtape 2 : Synchronisation (si n√©cessaire)

### Si des changements sont d√©tect√©s :

```bash
# Synchronisation compl√®te automatique
pnpm sync:full
```

**Ce que fait `pnpm sync:full` :**

1. **`db:pull`** - T√©l√©charge les nouvelles migrations depuis le cloud
2. **`types:gen`** - R√©g√©n√®re les types TypeScript depuis le sch√©ma cloud
3. **`types:check`** - V√©rifie que les types sont coh√©rents

### Ou synchronisation manuelle √©tape par √©tape :

```bash
# 1. R√©cup√©rer les migrations cloud
pnpm db:pull

# 2. R√©g√©n√©rer les types TypeScript
pnpm types:gen

# 3. V√©rifier que tout est synchronis√©
pnpm db:check
```

## üìä D√©tail des Commandes

### `pnpm db:status`

```bash
# Affiche l'√©tat complet de votre projet Supabase cloud
# ‚úÖ API: http://your-project.supabase.co (UP)
# ‚úÖ Auth: http://your-project.supabase.co/auth/v1 (UP)
# ‚úÖ Storage: http://your-project.supabase.co/storage/v1 (UP)
# üìä Database: PostgreSQL 15.1 (UP)
```

### `pnpm db:check`

```bash
# Script personnalis√© qui v√©rifie :
# - Migrations locales vs cloud
# - Sch√©ma de base coh√©rent
# - Derni√®re modification des tables
#
# Sortie exemple :
# ‚úÖ Local migrations: 5
# ‚úÖ Remote migrations: 5
# ‚úÖ Database schema: SYNCHRONIZED
# üïê Last sync: 2024-01-15 14:30:22
```

### `pnpm db:pull`

```bash
# T√©l√©charge TOUTES les nouvelles migrations depuis le cloud
# Cr√©e des fichiers dans apps/backend/supabase/migrations/
# ‚ö†Ô∏è NE modifie PAS les donn√©es locales, juste les fichiers de migration
```

### `pnpm types:gen`

```bash
# G√©n√®re apps/frontend/src/types/database.types.ts depuis le sch√©ma cloud
# Inclut toutes les tables, vues, fonctions, enums
# Types automatiquement synchronis√©s avec votre DB cloud
```

### `pnpm migration:status`

```bash
# Script qui liste le statut de chaque migration :
# ‚úÖ 20240112_initial_schema.sql (applied)
# ‚úÖ 20240113_add_users.sql (applied)
# ‚ùå 20240115_add_courses.sql (pending)
# üîÑ 20240116_update_auth.sql (local only)
```

## üõ† Scripts de V√©rification Personnalis√©s

### Script `check-db-sync.js`

```javascript
// scripts/check-db-sync.js
const { execSync } = require('child_process');
const fs = require('fs');

async function checkDatabaseSync() {
  try {
    console.log('üîç V√©rification de la synchronisation DB...');

    // Comparer les migrations locales vs cloud
    const localMigrations = fs
      .readdirSync('apps/backend/supabase/migrations')
      .filter(file => file.endsWith('.sql'));

    const remoteMigrations = execSync('supabase migration list --linked', { encoding: 'utf8' });

    console.log(`üìÇ Migrations locales: ${localMigrations.length}`);
    console.log(`‚òÅÔ∏è  Migrations cloud: ${remoteMigrations.split('\n').length - 1}`);

    // V√©rifier les types TypeScript
    const typesFile = 'apps/frontend/src/types/database.types.ts';
    const typesStats = fs.statSync(typesFile);
    const hoursOld = (Date.now() - typesStats.mtime.getTime()) / (1000 * 60 * 60);

    if (hoursOld > 24) {
      console.log('‚ö†Ô∏è  Types TypeScript datent de plus de 24h');
      console.log('üí° Ex√©cutez: pnpm types:gen');
    } else {
      console.log('‚úÖ Types TypeScript r√©cents');
    }
  } catch (error) {
    console.error('‚ùå Erreur lors de la v√©rification:', error.message);
    process.exit(1);
  }
}

checkDatabaseSync();
```

### Script `migration-status.js`

```javascript
// scripts/migration-status.js
const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

function getMigrationStatus() {
  console.log('üìã Statut des migrations:\n');

  try {
    // Lister les migrations locales
    const migrationsDir = 'apps/backend/supabase/migrations';
    const localFiles = fs
      .readdirSync(migrationsDir)
      .filter(file => file.endsWith('.sql'))
      .sort();

    // Obtenir le statut depuis Supabase
    const remoteStatus = execSync('supabase migration list --linked', { encoding: 'utf8' });
    const appliedMigrations = remoteStatus
      .split('\n')
      .filter(line => line.includes('Applied'))
      .map(line => line.split('|')[1]?.trim());

    localFiles.forEach(file => {
      const fileName = path.parse(file).name;
      const isApplied = appliedMigrations.some(applied => applied?.includes(fileName));
      const status = isApplied ? '‚úÖ Applied' : '‚è≥ Pending';
      console.log(`${status} ${file}`);
    });
  } catch (error) {
    console.error('‚ùå Erreur:', error.message);
  }
}

getMigrationStatus();
```

### Script `check-types-sync.js`

```javascript
// scripts/check-types-sync.js
const fs = require('fs');
const { execSync } = require('child_process');

function checkTypesSync() {
  console.log('üîç V√©rification des types TypeScript...');

  try {
    const typesFile = 'apps/frontend/src/types/database.types.ts';

    if (!fs.existsSync(typesFile)) {
      console.log('‚ùå Fichier de types manquant');
      console.log('üí° Ex√©cutez: pnpm types:gen');
      return;
    }

    const stats = fs.statSync(typesFile);
    const content = fs.readFileSync(typesFile, 'utf8');

    // V√©rifier la date de modification
    const hoursOld = (Date.now() - stats.mtime.getTime()) / (1000 * 60 * 60);

    // V√©rifier si le contenu semble valide
    const hasExports = content.includes('export type Database');
    const hasTables = content.includes('Tables:');

    if (!hasExports || !hasTables) {
      console.log('‚ùå Types corrompus ou invalides');
      console.log('üí° Ex√©cutez: pnpm types:gen');
      return;
    }

    if (hoursOld > 24) {
      console.log(`‚ö†Ô∏è  Types datent de ${Math.round(hoursOld)}h`);
      console.log('üí° Consid√©rez: pnpm types:gen');
    } else {
      console.log('‚úÖ Types √† jour');
    }

    console.log(`üìÖ Derni√®re modification: ${stats.mtime.toLocaleString()}`);
  } catch (error) {
    console.error('‚ùå Erreur:', error.message);
  }
}

checkTypesSync();
```

## üö® Situations de D√©synchronisation

### Cas 1 : Nouvelles Migrations dans le Cloud

**Sympt√¥mes :**

- Erreurs TypeScript sur les nouveaux types de DB
- Requ√™tes Supabase qui √©chouent
- Tables/colonnes manquantes

**Solution :**

```bash
pnpm db:pull      # R√©cup√®re les nouvelles migrations
pnpm types:gen    # R√©g√©n√®re les types
pnpm db:check     # V√©rifie la synchronisation
```

### Cas 2 : Modifications de Sch√©ma Non Appliqu√©es

**Sympt√¥mes :**

- `pnpm db:check` montre des diff√©rences
- Les types TypeScript ne correspondent pas

**Solution :**

```bash
pnpm db:push      # Pousse vos migrations locales vers le cloud
pnpm types:gen    # R√©g√©n√®re les types depuis le cloud
```

### Cas 3 : Conflit de Migrations

**Sympt√¥mes :**

- Erreurs lors de `db:pull` ou `db:push`
- Migrations en conflit

**Solution :**

```bash
# Option 1: Reset local et resync
pnpm db:reset-local
pnpm db:pull
pnpm types:gen

# Option 2: R√©solution manuelle
# 1. Examiner les conflits dans apps/backend/supabase/migrations/
# 2. R√©soudre manuellement
# 3. Pousser les changements
pnpm db:push
```

### Cas 4 : Types TypeScript Corrompus

**Sympt√¥mes :**

- Erreurs de compilation TypeScript
- Types manquants ou incorrects

**Solution :**

```bash
rm apps/frontend/src/types/database.types.ts
pnpm types:gen
pnpm typecheck
```

## ‚ö° Workflow Quotidien Recommand√©

### üåÖ D√©but de Journ√©e

```bash
# 1. R√©cup√©rer les derniers changements git
git pull origin main

# 2. V√©rifier l'√©tat de synchronisation
pnpm sync:check

# 3. Si des changements d√©tect√©s, synchroniser
pnpm sync:full

# 4. D√©marrer le d√©veloppement
pnpm dev
```

### üíª Pendant le D√©veloppement

```bash
# √Ä chaque modification de sch√©ma DB :
pnpm types:gen

# Avant chaque commit :
pnpm lint
pnpm typecheck
pnpm test
```

### üåô Fin de Journ√©e

```bash
# 1. Pousser les migrations vers le cloud (si applicable)
pnpm db:push

# 2. Commit des changements
git add .
git commit -m "feat: description des changements"
git push origin main

# 3. V√©rification finale
pnpm sync:check
```

## üîß Configuration du Projet

### Variables d'Environnement N√©cessaires

```env
# .env - Variables pour la synchronisation cloud
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...
SUPABASE_ACCESS_TOKEN=sbp_...
SUPABASE_PROJECT_REF=your-project-ref
SUPABASE_DB_PASSWORD=your-db-password
```

### Lien CLI avec le Projet Cloud

```bash
# Une seule fois lors de la configuration initiale
supabase login
supabase link --project-ref your-project-ref
```

## üìà Monitoring et Diagnostics

### Logs Supabase

```bash
# Voir les logs en temps r√©el
supabase logs --follow

# Logs sp√©cifiques
supabase logs --type api        # Logs API
supabase logs --type postgres   # Logs DB
supabase logs --type auth       # Logs Auth
```

### Dashboard Supabase

**URL :** `https://supabase.com/dashboard/project/your-project-ref`

**Sections importantes :**

- **Table Editor** : √âtat des donn√©es
- **SQL Editor** : Ex√©cuter des requ√™tes
- **Logs** : Monitoring en temps r√©el
- **Settings > API** : Credentials

## üö® D√©pannage

### Erreur "Project not linked"

```bash
supabase link --project-ref your-project-ref --password your-db-password
```

### Erreur "Migration conflict"

```bash
# Voir les migrations en conflit
pnpm migration:status

# R√©soudre manuellement ou reset
pnpm db:reset-local
pnpm db:pull
```

### Types TypeScript invalides

```bash
# V√©rifier la validit√©
pnpm types:check

# R√©g√©n√©rer compl√®tement
rm apps/frontend/src/types/database.types.ts
pnpm types:gen
```

### Base de donn√©es non accessible

```bash
# V√©rifier la connectivit√©
pnpm db:status

# V√©rifier les credentials dans .env
```

## üìã Checklist de Synchronisation

### ‚úÖ Avant de Commencer le Travail

- [ ] `git pull origin main`
- [ ] `pnpm install`
- [ ] `pnpm sync:check`
- [ ] `pnpm sync:full` (si n√©cessaire)
- [ ] `pnpm dev` d√©marre sans erreur

### ‚úÖ Pendant le D√©veloppement

- [ ] `pnpm types:gen` apr√®s chaque changement de sch√©ma
- [ ] `pnpm typecheck` r√©guli√®rement
- [ ] `pnpm db:check` si doute sur la synchronisation

### ‚úÖ Avant de Committer

- [ ] `pnpm lint` passe
- [ ] `pnpm typecheck` passe
- [ ] `pnpm test` passe
- [ ] `pnpm sync:check` confirme la synchronisation

### ‚úÖ Apr√®s le Commit

- [ ] `git push origin main`
- [ ] `pnpm db:push` (si migrations locales)
- [ ] V√©rifier sur le dashboard Supabase

## üéØ R√©sum√©

**L'objectif de ce syst√®me :**

1. **Toujours savoir** si votre environnement local est synchronis√©
2. **Synchronisation en un clic** avec `pnpm sync:full`
3. **Diagnostics pr√©cis** avec `pnpm sync:check`
4. **Pas de surprises** lors du d√©veloppement

**Commandes principales √† retenir :**

- `pnpm sync:check` - V√©rifier l'√©tat
- `pnpm sync:full` - Synchroniser compl√®tement
- `pnpm db:status` - √âtat de la connexion cloud
- `pnpm types:gen` - R√©g√©n√©rer les types

**Philosophie cloud-first :**

- ‚òÅÔ∏è Le cloud Supabase est la source de v√©rit√©
- üíª Le local se synchronise avec le cloud
- üîÑ Synchronisation fr√©quente et automatis√©e
- üéØ D√©veloppement sans friction

---

**üéâ Avec ce guide, vous ne perdrez plus jamais le contr√¥le de votre environnement de d√©veloppement !**
