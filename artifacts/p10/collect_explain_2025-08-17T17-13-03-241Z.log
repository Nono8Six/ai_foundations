{
  "description": "EXPLAIN ANALYZE collection",
  "exitCode": 3,
  "timestamp": "2025-08-17T17:13:03.241Z",
  "stdout": "📋 P10: Collecting EXPLAIN ANALYZE for key RPC functions...\r\n🔍 Analyzing credit_xp function...\r\n=====================================;\r\n                                                                              QUERY PLAN                                                                               \r\n-----------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n Result  (cost=0.00..0.26 rows=1 width=32) (actual time=0.958..0.958 rows=1 loops=1)\r\n   Output: credit_xp('00000000-0000-0000-0000-000000000001'::uuid, 'lesson:completion'::text, 50, 'explain-credit-xp-test'::text, NULL::uuid, NULL::text, '{}'::jsonb)\r\n   Buffers: shared hit=350\r\n Query Identifier: -2722577134236380289\r\n Planning Time: 0.024 ms\r\n Execution Time: 0.972 ms\r\n(6 rows)\r\n\r\n;\r\n🔍 Analyzing get_active_xp_sources function...\r\n==============================================;\r\n                                         QUERY PLAN                                          \r\n---------------------------------------------------------------------------------------------\r\n ProjectSet  (cost=0.00..5.27 rows=1000 width=32) (actual time=0.187..0.216 rows=24 loops=1)\r\n   Output: get_active_xp_sources(now())\r\n   Buffers: shared hit=2\r\n   ->  Result  (cost=0.00..0.01 rows=1 width=0) (actual time=0.001..0.001 rows=1 loops=1)\r\n Query Identifier: -1125711535403011146\r\n Planning Time: 0.025 ms\r\n Execution Time: 0.243 ms\r\n(7 rows)\r\n\r\n;\r\n🔍 Analyzing compute_level_info function...\r\n===========================================;\r\n                                         QUERY PLAN                                         \r\n--------------------------------------------------------------------------------------------\r\n ProjectSet  (cost=0.00..5.27 rows=1000 width=32) (actual time=0.283..0.288 rows=1 loops=1)\r\n   Output: compute_level_info(150)\r\n   Buffers: shared hit=4\r\n   ->  Result  (cost=0.00..0.01 rows=1 width=0) (actual time=0.001..0.001 rows=1 loops=1)\r\n Query Identifier: -6337873644889589703\r\n Planning Time: 0.019 ms\r\n Execution Time: 0.310 ms\r\n(7 rows)\r\n\r\n;\r\n🔍 Skipping unlock_achievement analysis (schema mismatch issue)...\r\n====================================================================;\r\n;\r\n📊 Index Usage Analysis;\r\n========================;\r\n schemaname |     tablename     |                            indexname                            | scans | tuples_read | tuples_fetched \r\n------------+-------------------+-----------------------------------------------------------------+-------+-------------+----------------\r\n public     | level_definitions | ix_level_definitions_level_xp_required                          |  2729 |        2730 |           2729\r\n public     | level_definitions | level_definitions_pkey                                          |   164 |         684 |            684\r\n public     | level_definitions | idx_level_definitions_xp_required                               |     0 |           0 |              0\r\n public     | level_definitions | uq_xp_required                                                  |     0 |           0 |              0\r\n public     | level_definitions | uq_level                                                        |     0 |           0 |              0\r\n public     | profiles          | idx_profiles_user_id                                            |  1544 |       85568 |           1541\r\n public     | profiles          | profiles_pkey                                                   |   148 |         428 |            115\r\n public     | profiles          | idx_profiles_created_at                                         |    64 |          64 |             64\r\n public     | profiles          | profiles_email_key                                              |     0 |           0 |              0\r\n public     | profiles          | idx_profiles_admin                                              |     0 |           0 |              0\r\n public     | profiles          | idx_profiles_xp_level                                           |     0 |           0 |              0\r\n public     | profiles          | idx_profiles_email                                              |     0 |           0 |              0\r\n public     | user_achievements | idx_user_achievements_user_id                                   |     6 |          19 |             17\r\n public     | user_achievements | user_achievements_pkey                                          |     2 |           0 |              0\r\n public     | user_achievements | user_achievements_user_id_achievement_type_achievement_name_key |     0 |           0 |              0\r\n public     | user_achievements | ux_ua_user_ach_ver_scope                                        |     0 |           0 |              0\r\n public     | user_achievements | idx_user_achievements_user_type                                 |     0 |           0 |              0\r\n public     | user_achievements | idx_user_achievements_type                                      |     0 |           0 |              0\r\n public     | xp_events         | uk_xp_events_idempotency                                        |  1448 |         707 |            209\r\n public     | xp_events         | xp_events_pkey                                                  |    14 |          24 |             14\r\n public     | xp_events         | idx_xp_events_user_aggregates                                   |     2 |           2 |              0\r\n public     | xp_events         | idx_xp_events_user_created                                      |     1 |         174 |            162\r\n public     | xp_events         | idx_xp_events_source_stats                                      |     0 |           0 |              0\r\n public     | xp_events         | idx_xp_events_source_type                                       |     0 |           0 |              0\r\n public     | xp_events         | idx_xp_events_created_at                                        |     0 |           0 |              0\r\n public     | xp_sources        | uq_xp_sources_type_action_version                               |   100 |          96 |             92\r\n public     | xp_sources        | ex_xp_sources_active_overlap                                    |     6 |          24 |              4\r\n public     | xp_sources        | xp_sources_pkey                                                 |     5 |          36 |             36\r\n public     | xp_sources        | idx_xp_sources_active_type                                      |     3 |          30 |             20\r\n public     | xp_sources        | idx_xp_sources_active                                           |     0 |           0 |              0\r\n(30 rows)\r\n\r\n;\r\n📊 Table Statistics;\r\n===================;\r\n schemaname |     tablename     | seq_scan | seq_tup_read | idx_scan | idx_tup_fetch | inserts | updates | deletes | live_tuples | dead_tuples \r\n------------+-------------------+----------+--------------+----------+---------------+---------+---------+---------+-------------+-------------\r\n public     | level_definitions |     2901 |        40609 |     2893 |          3413 |      15 |      10 |       0 |          14 |          11\r\n public     | profiles          |    25600 |        26602 |     1756 |          1720 |      20 |    1491 |       0 |           5 |         327\r\n public     | user_achievements |     2343 |         6893 |        8 |            17 |      11 |       4 |       3 |           3 |          12\r\n public     | xp_events         |     3558 |        18696 |     1465 |           387 |    1269 |      15 |     975 |         169 |         326\r\n public     | xp_sources        |     1152 |         9281 |      114 |           152 |      47 |     174 |      22 |          24 |          34\r\n(5 rows)\r\n\r\n;\r\n🔧 Query Plan Cache Stats;\r\n==========================;\r\n funcname | calls | total_time | mean_time | self_time \r\n----------+-------+------------+-----------+-----------\r\n(0 rows)\r\n\r\n;\r\n💾 Buffer Cache Analysis;\r\n========================;\r\n      relname      |  size  | heap_read | heap_hit | cache_hit_ratio \r\n-------------------+--------+-----------+----------+-----------------\r\n level_definitions | 96 kB  |         0 |     5840 |          100.00\r\n profiles          | 328 kB |         1 |   195464 |          100.00\r\n user_achievements | 112 kB |         0 |     2345 |          100.00\r\n xp_events         | 336 kB |         0 |     9668 |          100.00\r\n xp_sources        | 128 kB |         0 |     3109 |          100.00\r\n(5 rows)\r\n\r\n;\r\n🔒 Lock Analysis;\r\n================;\r\n pid | locktype | mode | granted | table_name \r\n-----+----------+------+---------+------------\r\n(0 rows)\r\n\r\n;\r\n⚡ Performance Recommendations;\r\n==============================;\r\n",
  "stderr": "psql:C:/GitHub/ai_foundations_lms/scripts/p10/collect_explain.sql:208: ERROR:  unrecognized format() type specifier \".\"\r\nHINT:  For a single \"%\" use \"%%\".\r\nCONTEXT:  PL/pgSQL function inline_code_block line 56 at assignment\r\npsql:C:/GitHub/ai_foundations_lms/scripts/p10/collect_explain.sql:208: STATEMENT:  DO $$\r\nDECLARE\r\n  rec RECORD;\r\n  recommendations TEXT[] := ARRAY[]::TEXT[];\r\nBEGIN\r\n  -- Check for tables with low cache hit ratios\r\n  FOR rec IN \r\n    SELECT \r\n      c.relname,\r\n      CASE \r\n        WHEN (coalesce(s.heap_blks_read, 0) + coalesce(s.heap_blks_hit, 0)) > 0\r\n        THEN round((coalesce(s.heap_blks_hit, 0) * 100.0) / (coalesce(s.heap_blks_read, 0) + coalesce(s.heap_blks_hit, 0)), 2)\r\n        ELSE 100 \r\n      END as hit_ratio\r\n    FROM pg_class c\r\n    LEFT JOIN pg_statio_user_tables s ON c.oid = s.relid\r\n    WHERE c.relname IN ('xp_events', 'profiles', 'xp_sources', 'user_achievements', 'level_definitions')\r\n      AND s.schemaname = 'public'\r\n  LOOP\r\n    IF rec.hit_ratio < 95 THEN\r\n      recommendations := array_append(recommendations, \r\n        format('⚠️  Low cache hit ratio for %s: %.1f%% (target: >95%%)', rec.relname, rec.hit_ratio));\r\n    END IF;\r\n  END LOOP;\r\n  \r\n  -- Check for unused indexes\r\n  FOR rec IN\r\n    SELECT \r\n      indexrelname as indexname,\r\n      relname as tablename,\r\n      idx_scan\r\n    FROM pg_stat_user_indexes \r\n    WHERE relname IN ('xp_events', 'profiles', 'xp_sources', 'user_achievements', 'level_definitions')\r\n      AND idx_scan = 0\r\n  LOOP\r\n    recommendations := array_append(recommendations, \r\n      format('📋 Unused index detected: %s on %s (consider dropping)', rec.indexname, rec.tablename));\r\n  END LOOP;\r\n  \r\n  -- Check for high sequential scan ratios\r\n  FOR rec IN\r\n    SELECT \r\n      relname as tablename,\r\n      seq_scan,\r\n      idx_scan,\r\n      CASE \r\n        WHEN (seq_scan + idx_scan) > 0 \r\n        THEN round((seq_scan * 100.0) / (seq_scan + idx_scan), 2)\r\n        ELSE 0\r\n      END as seq_ratio\r\n    FROM pg_stat_user_tables \r\n    WHERE relname IN ('xp_events', 'profiles', 'xp_sources', 'user_achievements', 'level_definitions')\r\n      AND schemaname = 'public'\r\n  LOOP\r\n    IF rec.seq_ratio > 20 AND (rec.seq_scan + rec.idx_scan) > 100 THEN\r\n      recommendations := array_append(recommendations, \r\n        format('🔍 High sequential scan ratio for %s: %.1f%% (consider adding indexes)', rec.tablename, rec.seq_ratio));\r\n    END IF;\r\n  END LOOP;\r\n  \r\n  -- Output recommendations\r\n  IF array_length(recommendations, 1) > 0 THEN\r\n    RAISE NOTICE 'Performance Recommendations:';\r\n    FOR i IN 1..array_length(recommendations, 1) LOOP\r\n      RAISE NOTICE '%', recommendations[i];\r\n    END LOOP;\r\n  ELSE\r\n    RAISE NOTICE '✅ No performance issues detected';\r\n  END IF;\r\nEND $$;\r\n"
}